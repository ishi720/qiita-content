---
title: GitHubActionsでLambda関数を自動デプロイする
tags:
  - Python
  - AWS
  - Python3
  - lambda
  - GitHubActions
private: false
updated_at: '2025-08-16T07:14:04+09:00'
id: c69d2349b60b419caf0c
organization_url_name: null
slide: false
ignorePublish: false
---
# はじめに


本の記事は、前回の 「GithubActionsでLambdaの関数をデプロイする」 の続きです。

https://qiita.com/ishi720/items/3fc6ade75c54d3874819

今回は、**前回作成したLambda関数をGitHubでソース管理し、GitHub Actionsを使って自動的にAWSへデプロイできる仕組み** を作っていきます。

![quicksight-backup-lambda.drawio.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/473097/67c454d4-04b8-4537-9f45-7da0f943b0e5.png)

# ディレクトリ構成

プロジェクトは以下のような構成にしています。

```
root/
　├ .github/
　│　└ workflows/
　│　　　└ deploy-lambda.yml ← GithubActionsへのデプロイ設定
　└ lambda/
　 　└ quicksight_backup/
　 　　　└ main.py ← Lambdaの関数を配置
```

# Github シークレットキーの設定

GitHub ActionsからAWSにアクセスするため、以下のシークレットをGitHubリポジトリに設定します。

公開してしまわないようにご注意ください。

|シークレットキー|内容|
|-|-|
|AWS_ACCESS_KEY_ID|AWSのアクセスキー|
|AWS_SECRET_ACCESS_KEY|AWSのシークレットアクセスキー|

**設定方法**

GitHubリポジトリの [**Settings**] → [**Secrets and variables**] → [**Actions**] → [**New repository secret**] から追加できます。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/473097/3390f26f-f1b7-491a-aa29-e3dd4b317fbb.png)



# Lambda関数

前回の記事と同じ内容になるので説明は割愛します。

```python:main.py
import boto3
import json
import os
import logging

# ロガー設定
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# S3設定（環境変数から取得）
S3_BUCKET = os.environ.get("S3_BUCKET_NAME")
S3_PREFIX = os.environ.get("S3_PREFIX")
REGION = os.environ.get("AWS_REGION")
ACCOUNT_ID = os.environ.get("AWS_ACCOUNT_ID")

quicksight = boto3.client("quicksight", region_name=REGION)
s3 = boto3.client("s3")

def upload_to_s3(category, item_id, content, name):
    """
    指定されたQuickSightリソースの情報をS3バケットにJSON形式でアップロードする

    Parameters:
        category (str): リソースのカテゴリ（例: "datasource", "dataset", "analysis", "dashboard"）
        item_id (str): リソースの一意なID
        content (dict): アップロード対象のJSONデータ（describe_xxxのレスポンス）
        name (str): 表示名

    Raises:
        boto3.exceptions.Boto3Error: S3アップロードに失敗した場合にログにエラーを記録する
    """
    key = f"{S3_PREFIX}{category}/{category}_{item_id}.json"
    try:
        s3.put_object(
            Bucket=S3_BUCKET,
            Key=key,
            Body=json.dumps(content, indent=2, default=str),
            ContentType="application/json"
        )
        logger.info(f"S3アップロード成功: [{category.capitalize()}] {name} (ID: {item_id}) -> s3://{S3_BUCKET}/{key}")
    except Exception as e:
        logger.error(f"S3アップロード失敗: [{category.capitalize()}] {name} (ID: {item_id}) - エラー内容: {e}")

def backup_quicksight_resource(category, list_func_name, list_key, describe_func_name, id_key, name_key="Name"):
    """
    QuickSightリソースの一覧取得とS3バックアップを行う

    Parameters:
        category (str): リソースの種類（例: 'dataset'）
        list_func_name (str): 一覧取得API名（例: 'list_data_sets'）
        list_key (str): 一覧レスポンスのキー（例: 'DataSetSummaries'）
        describe_func_name (str): 詳細取得API名（例: 'describe_data_set'）
        id_key (str): IDフィールドのキー（例: 'DataSetId'）
        name_key (str): 名前フィールドのキー（例: 'Name'）
    """
    logger.info(f"▼▼ {category.capitalize()} のバックアップ開始 ▼▼")

    try:
        list_func = getattr(quicksight, list_func_name)
        describe_func = getattr(quicksight, describe_func_name)
    except AttributeError as e:
        logger.error(f"API関数取得エラー: {e}")
        return

    try:
        resources = list_func(AwsAccountId=ACCOUNT_ID).get(list_key, [])
    except Exception as e:
        logger.error(f"{category.capitalize()}一覧取得失敗: {e}")
        return

    for item in resources:
        item_id = item.get(id_key)
        item_name = item.get(name_key, "Unknown")
        try:
            response = describe_func(AwsAccountId=ACCOUNT_ID, **{id_key: item_id})
            upload_to_s3(category, item_id, response, item_name)
        except quicksight.exceptions.InvalidParameterValueException as e:
            logger.warning(f"スキップ:「{item_name}({item_id})」 - {e}")
        except Exception as e:
            logger.error(f"エラー: 「{item_name}({item_id})」 - {e}")
    logger.info(f"▲▲ {category.capitalize()} のバックアップ終了 ▲▲")


def lambda_handler(event, context):
    try:
        backup_quicksight_resource(
            category="datasource",
            list_func_name="list_data_sources",
            list_key="DataSources",
            describe_func_name="describe_data_source",
            id_key="DataSourceId"
        )
        backup_quicksight_resource(
            category="dataset",
            list_func_name="list_data_sets",
            list_key="DataSetSummaries",
            describe_func_name="describe_data_set",
            id_key="DataSetId"
        )
        backup_quicksight_resource(
            category="analysis",
            list_func_name="list_analyses",
            list_key="AnalysisSummaryList",
            describe_func_name="describe_analysis",
            id_key="AnalysisId"
        )
        backup_quicksight_resource(
            category="dashboard",
            list_func_name="list_dashboards",
            list_key="DashboardSummaryList",
            describe_func_name="describe_dashboard",
            id_key="DashboardId"
        )

        return {
            "statusCode": 200,
            "body": json.dumps("QuickSight backup completed.")
        }

    except Exception as e:
        logger.error(f"バックアップ処理中に予期せぬエラーが発生しました: {e}", exc_info=True)
        return {
            "statusCode": 500,
            "body": json.dumps(f"QuickSight backup failed: {str(e)}")
        }
```



# GithubActionsのでデプロイの設定

Lambda関数をAWSにデプロイするには、ZIPファイルを作成して `aws lambda update-function-code` コマンドを使って更新します。

※Lambdaの関数名で、`quicksight-backup`が存在している必要があります。

```yaml:deploy-lambda.yml
name: Deploy Lambda Function

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Set up Python 3.13
      uses: actions/setup-python@v4
      with:
        python-version: 3.13

    - name: Create deployment package
      run: |
        cd lambda
        zip -r ../function.zip .

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    - name: Deploy Lambda code
      run: |
        aws lambda update-function-code \
          --function-name quicksight-backup \
          --zip-file fileb://function.zip

    - name: Wait for function update to complete
      run: |
        echo "Waiting for Lambda update to finish..."
        sleep 10

    - name: Update Lambda handler (optional if unchanged)
      run: |
        aws lambda update-function-configuration \
          --function-name quicksight-backup \
          --handler quicksight_backup.main.lambda_handler
```

# デプロイ実行

GitHubに main ブランチへプッシュ、または Actions タブからワークフローを手動実行すると、デプロイが実行されます。

デプロイが完了すると以下のようになります。


![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/473097/0d5805f2-4bfc-42af-8a25-7bc78b0c3577.png)


Lambda関数を開くと以下のポップアップが表示され、「**Accept**」ボタンをクリックすることで、デプロイされた内容が反映されます。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/473097/bb11d5f4-84c9-498b-953b-c9f17cfc755e.png)






# まとめ

今回は、lambda関数のソース管理とGithubActionsでのデプロイを作成しました。

これで、関数の更新や復旧がより安全・確実になりますね！

機会があれば、CloudFormationを使ってのlambda以外のインフラ部分のデプロイも紹介出来たらと思います。

ここまで読んで頂きありがとうございました！
